# AI Agent Instructions - Polymarket BD Implementation

## ðŸŽ¯ Mission
Implement and deploy a complete Polymarket-style prediction marketplace with:
- **Supabase**: Database, Auth, Realtime, Edge Functions
- **Vercel**: Next.js Frontend
- **Docker**: n8n Automation (optional)

---

## ðŸ“‹ STEP-BY-STEP IMPLEMENTATION

### PHASE 1: Supabase Setup (Priority: CRITICAL)

#### 1.1 Create Supabase Project
```bash
# Go to https://app.supabase.com
# Click "New Project"
# Name: polymarket-bd
# Database Password: [generate secure password]
# Region: [closest to users - e.g., Singapore for Asia]
# Plan: Free Tier
```

#### 1.2 Apply Database Schema
1. Go to Supabase Dashboard > SQL Editor
2. Create new query
3. Copy contents from `/supabase/migrations/001_initial_schema.sql`
4. Run the query
5. Repeat for `002_matching_engine.sql`

#### 1.3 Configure Authentication
1. Go to Authentication > Settings
2. Enable "Email" provider
3. Disable "Confirm email" (for testing)
4. Set Site URL: `http://localhost:3000` (update after Vercel deploy)
5. Add Redirect URLs:
   - `http://localhost:3000/auth/callback`
   - `https://*.vercel.app/auth/callback`

#### 1.4 Enable Realtime
1. Go to Database > Replication
2. Enable realtime for tables:
   - `orders`
   - `trades`
   - `markets`

#### 1.5 Get API Credentials
1. Go to Project Settings > API
2. Copy:
   - Project URL
   - anon/public key
   - service_role key (keep secret!)

---

### PHASE 2: Next.js Frontend (Priority: CRITICAL)

#### 2.1 Create Project
```bash
npx create-next-app@latest polymarket-web --typescript --tailwind --app --src-dir
cd polymarket-web
```

#### 2.2 Install Dependencies
```bash
# Core
npm install @supabase/supabase-js @supabase/auth-helpers-nextjs

# State & Utils
npm install zustand date-fns recharts lucide-react

# UI
npx shadcn@latest init
npx shadcn@latest add button input card table dialog dropdown-menu tabs badge slider textarea alert checkbox label separator
```

#### 2.3 Create File Structure
Create these files in order:

**Config Files:**
1. `src/lib/supabase/client.ts`
2. `src/lib/supabase/server.ts`
3. `src/lib/supabase/middleware.ts`
4. `src/middleware.ts`
5. `src/types/index.ts`

**Components:**
1. `src/components/ui/` (auto-generated by shadcn)
2. `src/components/layout/Navbar.tsx`
3. `src/components/layout/Layout.tsx`
4. `src/components/market/MarketCard.tsx`
5. `src/components/trading/OrderBook.tsx`
6. `src/components/trading/PriceChart.tsx`
7. `src/components/trading/TradingPanel.tsx`

**Store:**
1. `src/store/useStore.ts`

**Pages:**
1. `src/app/layout.tsx`
2. `src/app/page.tsx` (Home)
3. `src/app/(auth)/login/page.tsx`
4. `src/app/(auth)/register/page.tsx`
5. `src/app/(dashboard)/markets/page.tsx`
6. `src/app/(dashboard)/markets/[id]/page.tsx`
7. `src/app/(dashboard)/portfolio/page.tsx`
8. `src/app/(dashboard)/wallet/page.tsx`
9. `src/app/admin/page.tsx`

#### 2.4 Environment Variables
Create `apps/web/.env.local`:
```env
NEXT_PUBLIC_SUPABASE_URL=https://YOUR_PROJECT.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

#### 2.5 Test Locally
```bash
npm run dev
# Open http://localhost:3000
```

---

### PHASE 3: Vercel Deployment (Priority: CRITICAL)

#### 3.1 Deploy to Vercel
```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Deploy
vercel --prod
```

#### 3.2 Configure Environment Variables
1. Go to Vercel Dashboard > Project Settings > Environment Variables
2. Add:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`

#### 3.3 Update Supabase Auth
1. Go to Supabase > Authentication > URL Configuration
2. Update Site URL to your Vercel domain
3. Add Redirect URL: `https://your-domain.vercel.app/auth/callback`

---

### PHASE 4: Docker/n8n (Priority: OPTIONAL)

#### 4.1 Create Docker Compose
Create `docker/n8n/docker-compose.yml` (see IMPLEMENTATION_GUIDE.md)

#### 4.2 Start n8n
```bash
cd docker/n8n
docker-compose up -d
```

#### 4.3 Configure Workflows
Access n8n at `http://localhost:5678` and create workflows:
1. News Scraper (Schedule trigger)
2. AI Oracle Verification (Webhook trigger)
3. Payment Verification (Webhook trigger)

---

## ðŸ”§ CRITICAL CODE SECTIONS

### Supabase Client (REQUIRED)
```typescript
// src/lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  )
}
```

### Store with Supabase (REQUIRED)
```typescript
// Key methods to implement in useStore.ts

fetchMarkets: async () => {
  const { data } = await supabase.from('markets').select('*');
  set({ markets: data || [] });
},

placeOrder: async (marketId, side, outcome, price, quantity) => {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return false;
  
  const { data, error } = await supabase
    .from('orders')
    .insert({ market_id: marketId, user_id: user.id, side, outcome, price, quantity })
    .select().single();
  
  if (error) return false;
  
  // Trigger matching engine
  await supabase.rpc('match_order', { p_order_id: data.id });
  return true;
},
```

### Realtime Subscription (REQUIRED)
```typescript
useEffect(() => {
  const channel = supabase
    .channel(`market:${marketId}`)
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'orders', filter: `market_id=eq.${marketId}` },
      (payload) => { fetchOrders(marketId); }
    )
    .subscribe();
  
  return () => { supabase.removeChannel(channel); };
}, [marketId]);
```

---

## âš ï¸ COMMON MISTAKES TO AVOID

1. **NEVER expose service_role key in client code**
   - Only use in server components/API routes
   - Use anon key for client-side

2. **Always enable RLS on tables**
   - Without RLS, data is publicly accessible
   - Test policies with different user roles

3. **Use correct Supabase client**
   - Browser client for client components
   - Server client for server components

4. **Handle auth state properly**
   - Use middleware for session refresh
   - Listen to auth state changes

5. **Validate all inputs**
   - Client-side validation for UX
   - Database constraints for security

---

## ðŸ§ª TESTING CHECKLIST

### Authentication
- [ ] User can register
- [ ] User can login
- [ ] User can logout
- [ ] Session persists on refresh
- [ ] Protected routes redirect to login

### Markets
- [ ] Markets list loads
- [ ] Market details display
- [ ] Price chart renders
- [ ] Order book shows data

### Trading
- [ ] Can place buy order
- [ ] Can place sell order
- [ ] Order appears in order book
- [ ] Wallet balance updates
- [ ] Position updates after trade

### Admin
- [ ] Admin can access admin panel
- [ ] Can create new market
- [ ] Can resolve market

---

## ðŸ“ž EMERGENCY CONTACTS

If stuck:
1. Check Supabase logs: Dashboard > Logs
2. Check Vercel logs: Dashboard > Deployments
3. Review browser console for errors
4. Test Supabase queries in SQL Editor

---

## âœ… DEPLOYMENT VERIFICATION

After deployment, verify:
1. Website loads: `https://your-domain.vercel.app`
2. Login works
3. Markets display
4. Can place test order
5. Realtime updates work
6. Admin panel accessible (with admin account)

**Success Criteria:**
- All pages load without errors
- Authentication works end-to-end
- Trading flow completes
- Data persists in Supabase
